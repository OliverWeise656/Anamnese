<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprachverständnis-Test</title>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            box-sizing: border-box;
        }
        #chatbot, #tone-setting, #initial-test, #hearing-test-info, #test, #hearing-test {
            background: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            padding: 30px;
        }
        h1 {
            font-size: 2em;
            margin-bottom: 20px;
        }
        p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .hidden {
            display: none;
        }
        .message {
            margin: 10px 0;
            padding: 12px;
            border-radius: 12px;
        }
        .user {
            background-color: #d1e7dd;
            text-align: right;
        }
        .doktor {
            background-color: #f8d7da;
            text-align: left;
        }
        .test-area {
            display: none;
        }
        input[type="text"] {
            width: calc(100% - 24px);
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
        }
        button {
            padding: 12px 24px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            background-color: #007bff;
            color: #fff;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }
        button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f8f9fa;
        }
        canvas {
            margin-top: 20px;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image-more/2.9.0/dom-to-image-more.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Supabase Client für DB-Speicherung -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="consent-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: #fff; padding: 20px; border-radius: 8px; max-width: 500px; text-align: center;">
            <h2>Datenschutz-Einwilligung</h2>
            <p>Ich stimme zu, dass meine anonymisierten Ergebnisse (ohne Namen) per Supabase-Cloud gespeichert und an die Praxis weitergeleitet werden. Die ID wird nur zur Zuordnung verwendet.</p>
            <button id="consent-yes">Ja, einverstanden</button>
            <button id="consent-no">Nein, abbrechen</button>
        </div>
    </div>

    <div id="id-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: #fff; padding: 20px; border-radius: 8px; max-width: 500px; text-align: center;">
            <h2>Ihre Untersuchungs-ID</h2>
            <p id="id-display" style="font-size: 1.5em; color: #007bff;"></p>
            <p>Machen Sie einen Screenshot oder notieren Sie sich die ID für die Praxis.</p>
            <button id="id-ok">OK</button>
            <button id="test-id-button" style="background: orange; margin-left: 10px;">Test-ID (Debug)</button>
        </div>
    </div>

    <div id="chatbot">
        <div style="color: white; margin-top: 33em; text-align: center; font-size: 1.5em;">
            Hallo Welt!<p>
        </div>   
        <h1><span style="color: blue;">Ihre Buchung war erfolgreich!</span></h1>
        <p><span style="color: blue;">Schauen Sie bitte auch in Ihren SPAM Ordner!</span></p>
        <p>Wenn Sie uns das erste Mal besuchen oder eine akute Hör- oder Stimmstörung beklagen, bitten wir Sie, die folgenden Online-Tests durchzuführen.<p><span style="color: green;"> Ansonsten ist Ihre Buchung an dieser Stelle abgeschlossen.</span></p>
        <p>Beantworten Sie die Fragen stichwortartig und führen Sie die Tests nach bestem Können durch. Dauer: maximal 10 Minuten.</p>
        <p><span style="color: green;">Ihre Ergebnisse werden automatisch an die Praxis übermittelt. Notieren Sie sich die Untersuchungs-ID, die Sie erhalten, und teilen Sie sie bei Ihrem Termin mit.</span></p>
        <p>Sollten Sie die Tests nicht sofort durchführen können, erhalten Sie in den Erinnerungsmails einen Link...</p>
    </div>

    <div id="tone-setting" class="hidden">
        <h1>Ton-Einstellung</h1>
        <p>Die folgenden Tests werden mit Kopfhörern durchgeführt. Wenn Sie keine Kopfhörer zur Hand haben, können Sie die Tests auch ohne durchführen. In diesem Fall ist das Ergebnis jedoch nicht so aussagekräftig. <p>Bitte achten Sie darauf, dass der Test in einer ruhigen Umgebung durchgeführt wird. <p>Der Test ist so konzipiert, dass das Kind nachsprechen oder als gehört anzeigen soll.</p>
        <p>Nach dem Drücken von „Start“ hören Sie einen Ton. Stellen Sie die Lautstärke Ihres Kopfhörers oder Lautsprechers so ein, dass der Patient den Ton AUF DEM BESSEREN OHR gerade noch hören kann. <p>Falls Sie ohne Kopfhörer arbeiten, stellen Sie den Ton etwas lauter ein. <p>Wenn Sie die Einstellung beendet haben, drücken Sie „Stopp“. <p>Es folgen dann 3 unterschiedliche Hörtests.</p>
        <button id="startButton">Start</button>
        <button id="stopButton" disabled>Stopp</button>
    </div>

    <div id="initial-test" class="hidden">
        <h1 id="initial-test-heading">Sprachverständnis-Test</h1>
        <p>Tragen Sie das gehört Wort in das dafür vorgesehene Feld ein. Wenn Sie das Wort nicht verstehen, lassen Sie das Feld bitte leer und bestätigen Sie ohne Eintrag.<p><span style="color: red;">Wichtig zu beachten: Bei den folgenden Tests ist es unmöglich, die volle Punktzahl zu erreichen. Hier werden bewusst Grenzen ausgelotet!</span><p>
        <p id="initial-instructions">Bitte drücken Sie den Button, um den Test zu starten.</p>
        <button id="start-initial-test-button">Test starten</button>
        <div id="test-area">
            <p id="audio-instruction"></p>
            <input type="text" id="answer-input">
            <button id="submit-initial-test-button">Bestätigen</button>
        </div>
        <p id="initial-test-result" class="hidden"></p>
    </div>

    <div id="hearing-test-info" class="hidden">
        <h1>Sprachverständnis im Störschall</h1>
        <p>Während dieses Tests werden Ihnen Wörter im Hintergrundrauschen vorgespielt. Ihre Aufgabe besteht darin, das gehörte Wort in das Textfeld einzugeben. Falls Sie das Wort nicht verstanden haben, lassen Sie das Feld einfach leer und bestätigen ohne Eintrag. <p>Für diesen Test können Sie die Lautstärke beliebig einstellen.<p><span style="color: red;"> Vorsicht! Nicht erschrecken! Das Rauschen wird teilweise als unangenehm laut empfunden.</span></p>
        <button id="start-hearing-test-button">Test starten</button>
    </div>

    <div id="test" class="hidden">
        <h1>Sprachverständnis im Störschall</h1>
        <audio id="audioPlayer"></audio>
        <input type="text" id="response" placeholder="Ihre Antwort...">
        <button id="nextButton">Nächstes Wort</button>
    </div>

    <div id="hearing-test" class="hidden">
        <h1>Hörtest</h1>
        <div id="instructions">
            <p>Auf jeder Seite werden Sie sechs Töne hören. Zuerst wird Ihr rechtes Ohr getestet. Bitte drücken Sie den Knopf, sobald Sie einen Ton wahrnehmen.</p>
            <button onclick="startTest('right')">Rechtes Ohr Testen</button>
        </div>
        <div id="right-test-done" class="hidden">
            <p>Der Hörtest für das rechte Ohr ist abgeschlossen. Nun folgt der Test für das linke Ohr. Bitte schauen Sie nach Abschluss des Tests, ob sich weitere Fenster geöffnet haben.</p>
            <button onclick="startTest('left')">Linkes Ohr Testen</button>
        </div>
        <div id="test-area">
            <button onclick="heardTone()">Ton gehört</button>
        </div>
        <div id="results" class="hidden">
            <h2>Ergebnisse</h2>
            <canvas id="resultsChart" width="400" height="200"></canvas>
        </div>
    </div>

    <div id="final-result" class="hidden"></div>
    <div id="thank-you" class="hidden">
        <h1>Herzlichen Dank für Ihre Mitarbeit.</h1>
        <p>Ihre Ergebnisse wurden automatisch in unserer Cloud gespeichert und an die Praxis übermittelt. Notieren Sie sich die Untersuchungs-ID, die Sie zu Beginn erhalten haben, und teilen Sie sie bei Ihrem Termin mit, damit wir Ihre Daten zuordnen können.</p>
        <p>Bitte beachten Sie, dass der Hörtest besonderer Interpretation bedarf und nur für den Gebrauch in unserer Praxis vorgesehen ist!</p>
    </div>

    <script src="script.js"></script>
</body>
</html>
